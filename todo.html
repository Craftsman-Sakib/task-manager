<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Task Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f3f3;
            color: #333;
            line-height: 1.6;
            display: flex;
        }

        /* Navigation Panel */
        .navigation-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 60px;
            height: 100vh;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: width 0.3s ease;
            /* Changed for left position */
        }

        .navigation-panel:hover {
            width: 200px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .nav-item i {
            margin-right: 15px;
            width: 25px;
            text-align: center;
        }

        .nav-item span {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }

        .navigation-panel:hover .nav-item span {
            opacity: 1;
        }

        .nav-item:hover {
            background-color: #e9ecef;
        }

        /* Main Content Area */
        .app-container {
            display: flex;
            flex-grow: 1;
            padding-left: 60px;
            transition: padding-left 0.3s ease;
            /* Adjusted to work with left panel */
            height: 100vh;
            overflow: hidden;
            /* prevent content overflow that causes a second scroll bar */

        }

        .navigation-panel:hover+.app-container {
            padding-left: 200px;
        }

        @media (max-width: 768px) {
            .navigation-panel {
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: center;
            }

            .app-container {
                padding-left: 0;
                margin-top: 60px;
            }

            .navigation-panel:hover+.app-container {
                padding-left: 0;
            }
        }


        /* Sidebar Styles */
        .sidebar {
            width: 350px;
            background-color: #f0f0f0;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            height: 100%;
            overflow-y: auto;
            /* Allow sidebar content to scroll if needed */

        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .sidebar-header h1 {
            color: #007bff;
            font-size: 24px;
            font-weight: 600;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .priority-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .priority-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .priority-label input {
            margin-right: 5px;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            gap: 5px;
        }

        .file-input-label input[type="file"] {
            display: none;
        }

        .add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-btn:hover {
            background-color: #218838;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: white;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            position: relative;
            /* For absolute positioning of count */
        }

        .tab.active {
            background-color: #007bff;
            color: white;
        }

        /* Task List Container */
        .task-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Task Card Styles */
        .task-card {
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: box-shadow 0.3s;
            background-color: #f8f8f8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        /* Priority Task Card */
        .task-card.priority {
            border-left: 5px solid #dc3545;
            background-color: #fff3f3;
        }

        /* Routine Task Card */
        .task-card.routine {
            background-color: #f0f7ff;
            border: 1px solid #b8daff;
        }


        .task-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .task-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .task-details {
            flex-grow: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .task-tags {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            background-color: #f1f1f1;
            color: #333;
        }

        .tag-todo {
            background-color: #007bff;
            color: white;
        }

        .tag-routine {
            background-color: #28a745;
            color: white;
        }

        .tag-priority {
            background-color: #dc3545;
            color: white;
        }

        .routine-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .routine-schedule {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        /* Homepage Modal Styles */
        .homepage-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .homepage-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .homepage-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .homepage-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .homepage-btn-primary {
            background-color: #007bff;
            color: white;
        }

        .homepage-btn-primary:hover {
            background-color: #0056b3;
        }

        .homepage-btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .homepage-btn-secondary:hover {
            background-color: #545b62;
        }

        /* Modal Overlay */
        .task-creation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Modal Content Styling */
        .task-creation-content {
            background-color: white;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Advanced Input Group */
        .advanced-input-group {
            margin-bottom: 15px;
        }

        .subtask-list {
            margin-top: 12px;
            padding: 10px;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .subtask-input {
            flex-grow: 1;
            margin-right: 10px;
        }

        /* Color Selector Styling */
        .color-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.selected {
            border-color: #007bff;
        }

        /* Custom Color styling for tasks*/
        .task-card.custom-color {
            border-left: 5px solid;
        }

        /* Calendar View */
        .calendar {
            display: flex;
            overflow-x: auto;
            padding: 10px;
            margin-top: 20px;
            gap: 15px;
            /* Spacing between days */
            height: calc(100vh - 150px);
            /* Set height to fill remaining screen space with top and bottom padding */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 10px;
            /* Add left and right padding */
        }

        .calendar-day {
            min-width: 200px;
            /* Minimum width of a day container */
            padding: 10px;
            text-align: center;
            background-color: #f0f0f0;
            border-radius: 5px;
            border: 1px solid #ddd;
            overflow: hidden;
            /* Ensure content doesn't overflow */
        }


        .routine-card {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 5px;
            position: relative;
            border-left: 5px solid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .routine-card .task-image {
            width: 100%;
            height: 100px;
            /* Set a fixed height */
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }


        .calendar-day .task-name {
            font-size: 12px;
            margin-bottom: 3px;
        }

        /* Reminder tag styles */
        .reminder-tag {
            background-color: #f7b801;
            color: #333;
        }

        /* Reminder details */
        .task-card .reminder-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .routine-card {
            position: relative;
        }

        .routine-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .routine-delete-btn:hover {
            opacity: 1;
        }

        .routine-delete-btn i {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <!-- Navigation Panel -->
    <div class="navigation-panel">
        <a href="todo.html" class="nav-item active">
            <i class="fas fa-tasks"></i>
            <span>Task Manager</span>
        </a>
        <a href="gaming.html" class="nav-item">
            <i class="fas fa-gamepad"></i>
            <span>Gaming Dashboard</span>
        </a>
        <a href="fitness.html" class="nav-item">
            <i class="fas fa-dumbbell"></i>
            <span>Fitness Tracker</span>
        </a>
        <a href="finance.html" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Finance Manager</span>
        </a>
        <a href="notes.html" class="nav-item">
            <i class="fas fa-sticky-note"></i>
            <span>Personal Notes</span>
        </a>
    </div>
    <!-- Main Content Area -->
    <div class="app-container">
        <!-- Sidebar with Input -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Task Manager</h1>
            </div>
            <div class="input-section">
                <div class="input-group">
                    <label for="taskName">Task Name</label>
                    <input type="text" id="taskName" placeholder="Enter task name" required>
                </div>
                <div class="input-group">
                    <label for="taskType">Task Type</label>
                    <select id="taskType">
                        <option value="todo">TODO</option>
                        <option value="routine">Routine</option>
                    </select>
                </div>

                <!-- Dynamic fields for Advanced Task -->
                <div id="advancedTaskFields">
                    <div class="input-group" id="priorityGroup">
                        <label>Priority</label>
                        <div class="priority-group">
                            <label class="priority-label">
                                <input type="radio" name="priority" value="low" checked> Low
                            </label>
                            <label class="priority-label">
                                <input type="radio" name="priority" value="medium"> Medium
                            </label>
                            <label class="priority-label">
                                <input type="radio" name="priority" value="high"> High
                            </label>
                        </div>
                    </div>
                    <div class="input-group" id="routineFrequencyGroup" style="display: none;">
                        <label for="routineFrequency">Routine Frequency</label>
                        <select id="routineFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="input-group" id="routineDateRange" style="display: none;">
                        <label>Date Range</label>
                        <div style="display: flex; gap:10px;">
                            <input type="date" id="routineStartDate">
                            <input type="date" id="routineEndDate">
                        </div>
                    </div>
                    <div class="input-group" id="colorSelectorGroup">
                        <label>Color Tag</label>
                        <div class="color-selector">
                            <div class="color-option" style="background-color: #007bff;" data-color="#007bff"></div>
                            <div class="color-option" style="background-color: #28a745;" data-color="#28a745"></div>
                            <div class="color-option" style="background-color: #dc3545;" data-color="#dc3545"></div>
                            <div class="color-option" style="background-color: #ffc107;" data-color="#ffc107"></div>
                            <div class="color-option" style="background-color: #6f42c1;" data-color="#6f42c1"></div>
                        </div>
                    </div>
                    <div class="input-group" id="dateTimeGroup">
                        <label for="taskDateTime">Date and Time</label>
                        <input type="datetime-local" id="taskDateTime">
                    </div>
                    <div class="input-group" id="reminderGroup">
                        <label>Reminders</label>
                        <div>
                            <label>
                                <input type="checkbox" id="emailReminder"> Email Reminder
                            </label>
                            <label>
                                <input type="checkbox" id="desktopNotification"> Desktop Notification
                            </label>
                        </div>
                    </div>
                    <div class="input-group" id="subtaskGroup">
                        <label>Subtasks</label>
                        <div id="subtaskContainer" class="subtask-list">
                            <div class="subtask-item">
                                <input type="text" class="subtask-input" placeholder="Enter subtask">
                                <button class="btn btn-danger">Remove</button>
                            </div>
                        </div>
                        <button id="addSubtaskBtn" class="btn btn-secondary">Add Subtask</button>
                    </div>
                    <div class="input-group" id="notesGroup">
                        <label for="taskNotes">Additional Notes</label>
                        <textarea id="taskNotes" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="taskImageUrl">Image URL</label>
                        <div class="file-input-wrapper">
                            <input type="text" id="taskImageUrl" placeholder="Enter image URL or upload">
                            <label class="file-input-label">
                                <input type="file" id="taskImageFile" accept="image/*">
                                <i class="fas fa-upload"></i> Upload
                            </label>
                        </div>
                    </div>

                </div>
                <button class="add-btn" id="addTaskButton">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
        </div>
        <!-- Main Content Display -->
        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-type="all">All Tasks</div>
                <div class="tab" data-type="todo">TODO</div>
                <div class="tab" data-type="routine">Routine</div>
                <div class="tab" data-type="priority">Priority</div>
            </div>
            <div id="taskList" class="task-list">
            </div>
            <div id="calendarView" style="display: none;">
                <div class="calendar-header">
                    <button id="prevWeek">
                        < Prev Week </button>
                            <span id="currentWeek">Current Week</span>
                            <button id="nextWeek"> Next Week > </button>
                </div>
                <div id="calendar" class="calendar">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Homepage Setting -->
    <div id="homepageModal" class="homepage-modal">
        <div class="homepage-modal-content">
            <h2>Set as Homepage</h2>
            <p>Would you like to set this Task Manager as your browser's default homepage?</p>
            <div class="homepage-modal-buttons">
                <button id="setHomepageBtn" class="homepage-btn homepage-btn-primary">Yes, Set Homepage</button>
                <button id="dismissHomepageBtn" class="homepage-btn homepage-btn-secondary">No, Thanks</button>
            </div>
        </div>
    </div>
    <div id="taskCreationModal" class="task-creation-modal">
        <div class="task-creation-content">
        </div>
    </div>
    <script>
        class EnhancedTaskManager {
            constructor() {
                // Retrieve tasks from localStorage with more robust parsing
                try {
                    this.tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                } catch (error) {
                    console.error('Error parsing tasks from localStorage:', error);
                    this.tasks = [];
                }

                // DOM Element References
                this.initializeElements();

                // Setup event listeners
                this.setupEventListeners();

                // Initial render of tasks
                this.renderTasks('all');

                // Set current week for Calendar
                this.currentDate = new Date();
                this.renderCalendar();
            }

            initializeElements() {
                // Basic Task Creation Elements
                this.taskList = document.getElementById('taskList');
                this.taskNameInput = document.getElementById('taskName');
                this.taskTypeSelect = document.getElementById('taskType');

                // Advanced Input Fields
                this.priorityGroup = document.getElementById('priorityGroup');
                this.routineFrequencyGroup = document.getElementById('routineFrequencyGroup');
                this.routineFrequencySelect = document.getElementById('routineFrequency');
                this.routineDateRange = document.getElementById('routineDateRange');
                this.routineStartDate = document.getElementById('routineStartDate');
                this.routineEndDate = document.getElementById('routineEndDate');
                this.colorSelectorGroup = document.getElementById('colorSelectorGroup');
                this.colorOptions = document.querySelectorAll('.color-option');
                this.dateTimeGroup = document.getElementById('dateTimeGroup');
                this.taskDateTimeInput = document.getElementById('taskDateTime');
                this.reminderGroup = document.getElementById('reminderGroup');
                this.subtaskGroup = document.getElementById('subtaskGroup');
                this.subtaskContainer = document.getElementById('subtaskContainer');
                this.addSubtaskBtn = document.getElementById('addSubtaskBtn');
                this.notesGroup = document.getElementById('notesGroup');
                this.taskNotesInput = document.getElementById('taskNotes');
                this.taskImageUrlInput = document.getElementById('taskImageUrl');
                this.taskImageFileInput = document.getElementById('taskImageFile');
                this.addTaskButton = document.getElementById('addTaskButton');

                // Calendar Elements
                this.calendarView = document.getElementById('calendarView');
                this.calendarElement = document.getElementById('calendar');
                this.currentWeekElement = document.getElementById('currentWeek');
                this.prevWeekButton = document.getElementById('prevWeek');
                this.nextWeekButton = document.getElementById('nextWeek');

                // Modal Elements
                this.taskCreationModal = document.getElementById('taskCreationModal');

                this.advancedTaskFields = document.getElementById('advancedTaskFields');
            }

            setupEventListeners() {
                // Task type change listener
                this.taskTypeSelect.addEventListener('change', () => this.handleTaskTypeChange());

                // File upload handler
                this.taskImageFileInput.addEventListener('change', (event) => this.handleImageUpload(event));

                // Tab filter event listeners
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (event) => this.handleTabChange(event));
                });

                // Add task button event listener
                this.addTaskButton.addEventListener('click', () => this.addTask());

                // Color selection
                this.colorOptions.forEach(option => {
                    option.addEventListener('click', () => this.handleColorSelection(option));
                });

                // Add subtask
                this.addSubtaskBtn.addEventListener('click', () => this.addSubtask());

                // Calendar week navigation
                this.prevWeekButton.addEventListener('click', () => this.changeWeek(-1));
                this.nextWeekButton.addEventListener('click', () => this.changeWeek(1));
            }

            handleTaskTypeChange() {
                // Show/hide routine details based on task type
                this.routineFrequencyGroup.style.display =
                    this.taskTypeSelect.value === 'routine' ? 'block' : 'none';
                this.routineDateRange.style.display =
                    this.taskTypeSelect.value === 'routine' ? 'block' : 'none';
                // Show/hide advanced task settings
                const isRoutine = this.taskTypeSelect.value === 'routine';
                this.priorityGroup.style.display = isRoutine ? 'none' : 'flex';
                this.colorSelectorGroup.style.display = isRoutine ? 'none' : 'flex';
                this.dateTimeGroup.style.display = isRoutine ? 'none' : 'block';
                this.reminderGroup.style.display = isRoutine ? 'none' : 'block';
                this.subtaskGroup.style.display = isRoutine ? 'none' : 'block';
                this.notesGroup.style.display = isRoutine ? 'none' : 'block';
            }


            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.taskImageUrlInput.value = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }


            handleTabChange(event) {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

                // Add active class to clicked tab
                event.target.classList.add('active');

                // Filter tasks based on tab
                this.renderTasks(event.target.dataset.type);

                // Show/hide calendar based on selected tab
                if (event.target.dataset.type === 'routine') {
                    this.taskList.style.display = 'none';
                    this.calendarView.style.display = 'block';
                    this.renderCalendar();
                } else {
                    this.taskList.style.display = 'grid';
                    this.calendarView.style.display = 'none';
                }
            }

            handleColorSelection(option) {
                this.colorOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            }

            addSubtask() {
                const subtaskItem = document.createElement('div');
                subtaskItem.className = 'subtask-item';
                subtaskItem.innerHTML = `
                    <input type="text" class="subtask-input" placeholder="Enter subtask">
                    <button class="btn btn-danger">Remove</button>
                `;

                // Remove subtask functionality
                subtaskItem.querySelector('button').addEventListener('click', () => {
                    subtaskItem.remove();
                });

                this.subtaskContainer.appendChild(subtaskItem);
            }

            renderTasks(filterType = 'all') {
                // Clear existing task list
                this.taskList.innerHTML = '';

                // Filter tasks based on selected tab
                let filteredTasks = this.tasks;
                switch (filterType) {
                    case 'todo':
                        filteredTasks = this.tasks.filter(task => task.type === 'todo');
                        break;
                    case 'routine':
                        filteredTasks = this.tasks.filter(task => task.type === 'routine');
                        break;
                    case 'priority':
                        filteredTasks = this.tasks.filter(task => task.priority === 'high');
                        break;
                    default:
                        filteredTasks = this.tasks;
                }

                // Sort tasks (priority first, then by date)
                filteredTasks.sort((a, b) => {
                    // Sort by priority (high first)
                    const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                    const priorityComparison = (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                    if (priorityComparison !== 0) return priorityComparison;

                    // Then sort by date if priority is the same
                    return new Date(a.dateTime || 0) - new Date(b.dateTime || 0);
                });

                // Render each task
                filteredTasks.forEach(task => {
                    try {
                        const taskCard = document.createElement('div');
                        taskCard.className = `task-card ${task.priority === 'high' ? 'priority' : ''} ${task.type}`;

                        // Add image if exists
                        if (task.image) {
                            const img = document.createElement('img');
                            img.src = task.image;
                            img.className = 'task-image';
                            taskCard.appendChild(img);
                        }
                        // Custom color border
                        if (task.color) {
                            taskCard.style.borderLeftColor = task.color;
                        }

                        // Task details section
                        const details = document.createElement('div');
                        details.className = 'task-details';

                        // Task name
                        const nameEl = document.createElement('div');
                        nameEl.className = 'task-name';
                        nameEl.textContent = task.name;
                        details.appendChild(nameEl);

                        // Task tags
                        const tagsEl = document.createElement('div');
                        tagsEl.className = 'task-tags';

                        // Type tag
                        const typeTag = document.createElement('span');
                        typeTag.className = `tag tag-${task.type}`;
                        typeTag.textContent = (task.type || 'TODO').toUpperCase();
                        tagsEl.appendChild(typeTag);

                        // Priority tag
                        const priorityTag = document.createElement('span');
                        priorityTag.className = `tag ${task.priority === 'high' ? 'tag-priority' : ''}`;
                        priorityTag.textContent = task.priority.toUpperCase();
                        tagsEl.appendChild(priorityTag);

                        // Date/Time tag
                        if (task.dateTime) {
                            const dateTag = document.createElement('span');
                            dateTag.className = 'tag';
                            const formattedDate = new Date(task.dateTime);
                            if (formattedDate.getDate() !== new Date().getDate()) {
                                dateTag.textContent = formattedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                            } else {
                                dateTag.textContent = formattedDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                            }
                            tagsEl.appendChild(dateTag);
                        }

                        details.appendChild(tagsEl);

                        // Subtasks rendering
                        if (task.subtasks && task.subtasks.length > 0) {
                            const subtasksEl = document.createElement('div');
                            subtasksEl.className = 'subtasks';
                            subtasksEl.innerHTML = `<strong>Subtasks:</strong>`;
                            const subtaskList = document.createElement('ul');
                            subtaskList.className = 'subtask-list';
                            subtasksEl.appendChild(subtaskList);
                            task.subtasks.forEach(subtask => {
                                const subtaskItem = document.createElement('li');
                                subtaskItem.textContent = subtask;
                                subtaskList.appendChild(subtaskItem);
                            });
                            details.appendChild(subtasksEl);
                        }

                        // Notes rendering
                        if (task.notes) {
                            const notesEl = document.createElement('div');
                            notesEl.className = 'task-notes';
                            notesEl.innerHTML = `<strong>Notes:</strong> ${task.notes}`;
                            details.appendChild(notesEl);
                        }

                        // Reminders tag
                        if (task.reminders && (task.reminders.email || task.reminders.desktop)) {
                            const reminderTag = document.createElement('span');
                            reminderTag.className = 'tag reminder-tag';
                            reminderTag.textContent = 'Reminder Set';
                            tagsEl.appendChild(reminderTag);
                            if (task.dateTime) {
                                const reminderDetails = document.createElement('div');
                                reminderDetails.className = 'reminder-details';
                                const formattedDate = new Date(task.dateTime);
                                reminderDetails.textContent = `Reminder: ${formattedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })} at ${formattedDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
                                details.appendChild(reminderDetails);
                            }
                        }


                        taskCard.appendChild(details);

                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.onclick = () => this.deleteTask(task.id);
                        taskCard.appendChild(deleteBtn);

                        // Status toggle button
                        const statusBtn = document.createElement('button');
                        statusBtn.innerHTML = task.status === 'completed' ? '✓ Completed' : 'Mark Complete';
                        statusBtn.className = `status-btn ${task.status === 'completed' ? 'completed' : ''}`;
                        statusBtn.onclick = () => this.toggleTaskStatus(task.id);
                        taskCard.appendChild(statusBtn);

                        this.taskList.appendChild(taskCard);
                    } catch (error) {
                        console.error('Error rendering task:', task, error);
                    }
                });
            }

            toggleTaskStatus(taskId) {
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    this.tasks[taskIndex].status =
                        this.tasks[taskIndex].status === 'completed' ? 'pending' : 'completed';
                    this.saveTasks();
                    this.renderTasks(document.querySelector('.tab.active').dataset.type);
                }
            }

            addTask() {
                // Get input values
                const taskName = this.taskNameInput.value.trim();
                const taskType = this.taskTypeSelect.value;

                // Validate task name
                if (!taskName) {
                    alert('Please enter a task name.');
                    return;
                }

                let taskData = {
                    id: Date.now(),
                    name: taskName,
                    type: taskType || 'todo',
                    status: 'pending',
                };

                if (taskType === 'routine') {
                    const routineFrequency = this.routineFrequencySelect.value;
                    const startDate = this.routineStartDate.value;
                    const endDate = this.routineEndDate.value;

                    // Validate routine details
                    if (!routineFrequency || !startDate || !endDate) {
                        alert('Please fill in all routine details (frequency, start date, end date).');
                        return;
                    }

                    // Generate a more specific routine identifier
                    const routineId = `routine_${Date.now()}`;

                    taskData = {
                        ...taskData,
                        routineId: routineId,
                        routineFrequency: routineFrequency,
                        startDate: startDate,
                        endDate: endDate,
                        image: this.taskImageUrlInput.value.trim() || '',
                        notes: this.taskNotesInput.value.trim(),
                        dateTime: new Date().toISOString(), // Use current time for routine tasks
                    };
                }
                else {
                    const selectedPriority = document.querySelector('input[name="priority"]:checked');
                    const selectedColorOption = document.querySelector('.color-option.selected');
                    taskData = {
                        ...taskData,
                        priority: selectedPriority ? selectedPriority.value : 'low',
                        color: selectedColorOption ? selectedColorOption.dataset.color : null,
                        dateTime: this.taskDateTimeInput.value,
                        subtasks: Array.from(this.subtaskContainer.querySelectorAll('.subtask-input'))
                            .map(input => input.value.trim())
                            .filter(subtask => subtask !== ''),
                        notes: this.taskNotesInput.value.trim(),
                        reminders: {
                            email: document.getElementById('emailReminder').checked,
                            desktop: document.getElementById('desktopNotification').checked
                        },
                        image: this.taskImageUrlInput.value.trim() || '',
                    }
                }

                // Add task to tasks array
                this.tasks.push(taskData);

                // Save tasks to localStorage
                this.saveTasks();

                // Render tasks or calendar based on task type
                if (taskType === 'routine') {
                    this.renderCalendar();
                }
                else {
                    // Render tasks (maintaining current filter)
                    const activeTab = document.querySelector('.tab.active').dataset.type;
                    this.renderTasks(activeTab);
                }

                // Clear input fields
                this.clearInputs();
            }


            saveTasks() {
                try {
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                } catch (error) {
                    console.error('Error saving tasks to localStorage:', error);
                }
            }

            deleteTask(taskId) {
                // Remove task from tasks array
                this.tasks = this.tasks.filter(task => task.id !== taskId);

                // Save updated tasks
                this.saveTasks();

                // Re-render tasks (maintaining current filter)
                const activeTab = document.querySelector('.tab.active').dataset.type;
                if (activeTab === 'routine') {
                    this.renderCalendar();
                } else {
                    this.renderTasks(activeTab);
                }

            }


            clearInputs() {
                // Reset all input fields
                this.taskNameInput.value = '';
                this.taskTypeSelect.value = 'todo';
                this.priorityGroup.style.display = 'flex';
                this.colorSelectorGroup.style.display = 'flex';
                this.dateTimeGroup.style.display = 'block';
                this.reminderGroup.style.display = 'block';
                this.subtaskGroup.style.display = 'block';
                this.notesGroup.style.display = 'block';
                document.querySelector('input[name="priority"][value="low"]').checked = true;
                this.colorOptions.forEach(opt => opt.classList.remove('selected'));
                this.taskDateTimeInput.value = '';
                this.subtaskContainer.innerHTML = `
<div class="subtask-item">
<input type="text" class="subtask-input" placeholder="Enter subtask">
<button class="btn btn-danger">Remove</button>
</div>
`;
                this.taskNotesInput.value = '';
                document.getElementById('emailReminder').checked = false;
                document.getElementById('desktopNotification').checked = false;
                this.routineFrequencyGroup.style.display = 'none';
                this.routineDateRange.style.display = 'none';
                this.routineFrequencySelect.value = 'daily';
                this.routineStartDate.value = '';
                this.routineEndDate.value = '';
                this.taskImageUrlInput.value = '';
                this.taskImageFileInput.value = '';
            }
            changeWeek(direction) {
                this.currentDate.setDate(this.currentDate.getDate() + (direction * 7));
                this.renderCalendar();
            }


            renderCalendar() {
                // Get the first day of the current week
                const firstDay = new Date(this.currentDate);
                firstDay.setDate(this.currentDate.getDate() - this.currentDate.getDay());

                // Set the current week display
                const lastDay = new Date(firstDay);
                lastDay.setDate(lastDay.getDate() + 6);
                this.currentWeekElement.textContent = `${firstDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${lastDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

                // Clear previous calendar
                this.calendarElement.innerHTML = '';

                // Generate days
                for (let i = 0; i < 7; i++) {
                    const day = new Date(firstDay);
                    day.setDate(firstDay.getDate() + i);

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = day.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });

                    // Filter and sort routines for the current day
                    const dailyRoutines = this.tasks.filter(task => {
                        if (task.type !== 'routine') return false;

                        const startDate = new Date(task.startDate);
                        const endDate = new Date(task.endDate);

                        // Check if the current day is within the start and end dates
                        if (day < startDate || day > endDate) return false;

                        // Check routine frequency
                        return this.isRoutineDay(task, day);
                    }).sort((a, b) => a.name.localeCompare(b.name));

                    // Render each routine in its own card within the day
                    dailyRoutines.forEach((task) => {
                        const routineCard = document.createElement('div');
                        routineCard.className = 'routine-card';
                        routineCard.setAttribute('data-task-id', task.id);

                        // Add image if exists
                        if (task.image) {
                            const img = document.createElement('img');
                            img.src = task.image;
                            img.className = 'task-image';
                            routineCard.appendChild(img);
                        }

                        const taskName = document.createElement('div');
                        taskName.className = 'task-name';
                        taskName.textContent = task.name;
                        routineCard.appendChild(taskName);

                        // Add notes if exists
                        if (task.notes) {
                            const notesEl = document.createElement('div');
                            notesEl.className = 'routine-notes';
                            notesEl.textContent = task.notes;
                            routineCard.appendChild(notesEl);
                        }

                        // Delete button for routine task
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.className = 'delete-btn routine-delete-btn';
                        deleteBtn.onclick = (event) => {
                            event.stopPropagation(); // Prevent any parent event handlers
                            this.deleteRoutineTask(task.id);
                        };
                        routineCard.appendChild(deleteBtn);

                        dayDiv.appendChild(routineCard);
                    });

                    this.calendarElement.appendChild(dayDiv);
                }
            }

            // New method to delete routine tasks
            deleteRoutineTask(taskId) {
                // Confirm deletion
                const confirmDelete = confirm('Are you sure you want to delete this routine task?');
                if (!confirmDelete) return;

                // Remove task from tasks array
                this.tasks = this.tasks.filter(task => task.id !== taskId);

                // Save updated tasks
                this.saveTasks();

                // Re-render calendar
                this.renderCalendar();
            }

            isRoutineDay(task, day) {
                if (task.routineFrequency === 'daily') {
                    return true;
                } else if (task.routineFrequency === 'weekly') {
                    // Check if the day of the week matches
                    return day.getDay() === new Date(task.startDate).getDay();
                } else if (task.routineFrequency === 'monthly') {
                    // Check if the date of the month matches
                    return day.getDate() === new Date(task.startDate).getDate();
                }
                return false;
            }
        }

        // Initialize Task Manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const currentPage = window.location.pathname.split('/').pop();
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href === currentPage) {
                    item.classList.add('active');
                }
            });

            window.taskManager = new EnhancedTaskManager();


            const addAdvancedTaskBtn = document.createElement('button');
            addAdvancedTaskBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Advanced Task';
            addAdvancedTaskBtn.className = 'add-btn';
            addAdvancedTaskBtn.style.marginTop = '10px';

            // Add the button to the sidebar
            document.querySelector('.sidebar').appendChild(addAdvancedTaskBtn);
        });

        class HomepageManager {
            constructor() {
                this.modal = document.getElementById('homepageModal');
                this.setHomepageBtn = document.getElementById('setHomepageBtn');
                this.dismissHomepageBtn = document.getElementById('dismissHomepageBtn');

                this.init();
            }

            init() {
                // Check if homepage is already set
                if (this.isHomepageSet()) {
                    return;
                }

                // Check if user has previously dismissed the prompt
                if (this.hasUserDismissedPrompt()) {
                    return;
                }

                // Show homepage setting modal
                this.showModal();

                // Setup event listeners
                this.setHomepageBtn.addEventListener('click', () => this.setHomepage());
                this.dismissHomepageBtn.addEventListener('click', () => this.dismissPrompt());
            }

            isHomepageSet() {
                // This is a simplified check and might need browser-specific adjustments
                try {
                    return localStorage.getItem('isHomepageSet') === 'true';
                } catch (error) {
                    console.error('Error checking homepage status:', error);
                    return false;
                }
            }

            hasUserDismissedPrompt() {
                try {
                    return localStorage.getItem('homepagePromptDismissed') === 'true';
                } catch (error) {
                    console.error('Error checking prompt dismissal:', error);
                    return false;
                }
            }

            showModal() {
                this.modal.style.display = 'flex';
            }

            setHomepage() {
                try {
                    // Note: This is a hint to the browser. Actual homepage setting
                    // requires browser-specific methods or user manual settings
                    localStorage.setItem('isHomepageSet', 'true');
                    this.modal.style.display = 'none';
                    alert('This hint has been saved. You may need to set the homepage manually in your browser settings.');
                } catch (error) {
                    console.error('Error setting homepage:', error);
                    alert('Could not set homepage. Please set it manually in your browser settings.');
                }
            }

            dismissPrompt() {
                try {
                    localStorage.setItem('homepagePromptDismissed', 'true');
                    this.modal.style.display = 'none';
                } catch (error) {
                    console.error('Error dismissing homepage prompt:', error);
                }
            }
        }

        // Initialize Task Manager and Homepage Manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.homepageManager = new HomepageManager();
            } catch (error) {
                console.error('Error initializing managers:', error);
            }
        });
    </script>
</body>

</html>
